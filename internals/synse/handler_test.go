package synse

import (
	"bytes"
	"encoding/json"
	"errors"
	"image/png"
	"io"
	"net/http"
	"net/http/httptest"
	"os"
	"testing"
)

const body = `{
	"angle1": 72,
	"angle2": 148,
	"width": 500,
	"height": 500,
	"length": 0.1200000000000004,
	"lithology": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAYAAADL1t+KAAAbuElEQVR4Xu3dC09U59oG4AVW0ATSloTGttr+tf51RU62agVPUMTmnRbFAzDOrOP9XpPsdH8ps2Y91/18ufca1gwrf/zxx/vGgwABAgQIEJi0wIpCn3R+Tp4AAQIECMwEFLpFIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh2wECBAgQIBAgoNADQjQCAQIECBBQ6HaAAAECBAgECCj0gBCNQIAAAQIEFLodIECAAAECAQIKPSBEIxAgQIAAAYVuBwgQIECAQICAQg8I0QgECBAgQECh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ECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBAQKHbAQIECBAgECCg0ANCNAIBAgQIEFDodoAAAQIECAQIKPSAEI1AgAABAgQUuh0gQIAAAQIBAgo9IEQjECBAgAABhW4HCBAgQIBAgIBCDwjRCAQIECBA4F/IiMbbVsmD8AAAAABJRU5ErkJggg=="
}`

func TestUnmarshal(t *testing.T) {
	var synseRequest synseRequestModel
	if err := json.Unmarshal([]byte(body), &synseRequest); err != nil {
		t.Fatal(err)
	}
	img, err := fromDataUrl(synseRequest.Lithology)
	if err != nil {
		t.Fatal(err)
	}
	outFileName := "LithologyIn.png"
	if _, err := os.Stat(outFileName); errors.Is(err, os.ErrNotExist) {
		os.Remove(outFileName)
	}
	f, err := os.Create(outFileName)
	if err != nil {
		t.Fatal(err)
	}
	png.Encode(f, img)
}

func TestSeismicHandler(t *testing.T) {
	w := httptest.NewRecorder()
	reqBody := bytes.NewBuffer([]byte(body))
	r, err := http.NewRequest("POST", "/", reqBody)
	if err != nil {
		t.Fatal(err)
	}
	SeismicHandler(w, r)
	if w.Result().StatusCode != 200 {
		t.Fatal("status code not 200")
	}

	respBodyBytes, err := io.ReadAll(w.Body)
	if err != nil {
		t.Fatal(err)
	}
	var response SynseResponseModel
	if err := json.Unmarshal([]byte(respBodyBytes), &response); err != nil {
		t.Fatal(err)
	}
	img, err := fromDataUrl(response.SeismicImage)
	if err != nil {
		t.Fatal(err)
	}
	outFileName := "SeismicImageOut.png"
	if _, err := os.Stat(outFileName); errors.Is(err, os.ErrNotExist) {
		os.Remove(outFileName)
	}
	f, err := os.Create(outFileName)
	if err != nil {
		t.Fatal(err)
	}
	png.Encode(f, img)
}

func TestPsfTemporalHandler(t *testing.T) {
	w := httptest.NewRecorder()
	reqBody := bytes.NewBuffer([]byte(body))
	r, err := http.NewRequest("POST", "/", reqBody)
	if err != nil {
		t.Fatal(err)
	}
	PsfTemporalHandler(w, r)
	if w.Result().StatusCode != 200 {
		t.Fatal("status code not 200")
	}

	respBodyBytes, err := io.ReadAll(w.Body)
	if err != nil {
		t.Fatal(err)
	}
	var response TemporalResponseModel
	if err := json.Unmarshal([]byte(respBodyBytes), &response); err != nil {
		t.Fatal(err)
	}
	img, err := fromDataUrl(response.PsfImageFrequency)
	if err != nil {
		t.Fatal(err)
	}
	outFileName := "PsfImageFrequencyOut.png"
	if _, err := os.Stat(outFileName); errors.Is(err, os.ErrNotExist) {
		os.Remove(outFileName)
	}
	f, err := os.Create(outFileName)
	if err != nil {
		t.Fatal(err)
	}
	png.Encode(f, img)
}

func TestPsfSpatialHandler(t *testing.T) {
	w := httptest.NewRecorder()
	reqBody := bytes.NewBuffer([]byte(body))
	r, err := http.NewRequest("POST", "/", reqBody)
	if err != nil {
		t.Fatal(err)
	}
	PsfSpatialHandler(w, r)
	if w.Result().StatusCode != 200 {
		t.Fatal("status code not 200")
	}

	respBodyBytes, err := io.ReadAll(w.Body)
	if err != nil {
		t.Fatal(err)
	}
	var response SpatialresponseModel
	if err := json.Unmarshal([]byte(respBodyBytes), &response); err != nil {
		t.Fatal(err)
	}
	img, err := fromDataUrl(response.PsfImageSpatial)
	if err != nil {
		t.Fatal(err)
	}
	outFileName := "PsfImageSpatialOut.png"
	if _, err := os.Stat(outFileName); errors.Is(err, os.ErrNotExist) {
		os.Remove(outFileName)
	}
	f, err := os.Create(outFileName)
	if err != nil {
		t.Fatal(err)
	}
	png.Encode(f, img)
}
